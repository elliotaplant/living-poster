<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>Surf Poster Telemetry</title>
  </head>
  <body>
    <div
      style="
        margin: 0 auto;
        padding: 2em;
        display: flex;
        flex-direction: column;
        gap: 1em;
      "
    >
      <canvas id="heartbeatsChart"></canvas>
      <canvas id="batteriesChart"></canvas>
      <canvas id="millisChart"></canvas>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.2.1/luxon.min.js"
      integrity="sha512-pyR2hpC7bLig9Ub4eUIOC/BAO4anpdt7jhpF4dfrPv+qIg+KWztdVjFPCRCsRaWVfUylUCvrrxqMFNrJBdQIjQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
      module="true"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@^1"></script>

    <script>
      const createdAtFormat = 'yyyy-MM-dd hh:mm:ss';
      const { DateTime, Interval } = luxon;
      async function onload() {
        const heartbeats = await (
          await fetch(
            'https://living-poster.elliotaplant9602.workers.dev/telemetry?poster_id=1'
          )
        ).json();
        const batteries = await (
          await fetch(
            'https://living-poster.elliotaplant9602.workers.dev/battery?poster_id=1'
          )
        ).json();

        const heartbeatsChartCtx = document.getElementById('heartbeatsChart');
        const batteriesChartCtx = document.getElementById('batteriesChart');
        const millisChartCtx = document.getElementById('millisChart');

        new Chart(heartbeatsChartCtx, {
          type: 'bar',
          data: {
            datasets: [
              {
                label: '# of Heartbeats',
                data: heartbeats.map((hb) => ({
                  y: hb.count,
                  x: DateTime.fromISO(hb.hour, { zone: 'utc' }),
                })),
              },
            ],
          },
          options: {
            scales: {
              x: {
                type: 'time',
                title: {
                  display: true,
                  text: 'Hour',
                },
              },
            },
          },
        });

        new Chart(batteriesChartCtx, {
          type: 'line',
          data: {
            datasets: [
              {
                label: 'Battery',
                data: batteries.map((b) => ({
                  y: b.battery,
                  x: DateTime.fromFormat(b.created_at, createdAtFormat, {
                    zone: 'utc',
                  }),
                })),
              },
            ],
          },
          options: { scales: { x: { type: 'time' } } },
        });

        new Chart(millisChartCtx, {
          type: 'line',
          data: {
            datasets: [
              {
                label: 'Millis',
                data: batteries.map((b) => ({
                  y: b.millis,
                  x: DateTime.fromFormat(b.created_at, createdAtFormat, {
                    zone: 'utc',
                  }),
                })),
              },
            ],
          },
          options: { scales: { x: { type: 'time' } } },
        });
      }

      document.addEventListener(
        'DOMContentLoaded',
        () => onload().catch(console.error),
        false
      );
    </script>
  </body>
</html>
